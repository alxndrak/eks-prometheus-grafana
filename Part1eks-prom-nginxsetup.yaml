#Create EKS cluster 
eksctl create cluster --node-volume-size=15 --zones=us-east-1a,us-east-1b

#Install csi driver for EBS (for statefulsets volumes)

#get your clustername 
aws eks list-clusters
cluster_name=floral-creature-1722365091

#Create an IAM OIDC identity provider
eksctl utils associate-iam-oidc-provider --cluster $cluster_name --approve

#Create iam role 
eksctl create iamserviceaccount \
    --name ebs-csi-controller-sa \
    --namespace kube-system \
    --cluster $cluster_name \
    --role-name AmazonEKS_EBS_CSI_DriverRole \
    --role-only \
    --attach-policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy \
    --approve

eksctl create addon --name aws-ebs-csi-driver --cluster $cluster_name --service-account-role-arn arn:aws:iam::111111111111:role/AmazonEKS_EBS_CSI_DriverRole --force

#Install Grafana and Prometheus stack using helm

helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
helm install prometheus prometheus-community/kube-prometheus-stack \
--namespace monitoring --create-namespace

#Access Grafana locally

k get pod 
kubectl port-forward deployment/prometheus-grafana 3000 -n monitoring
open localhost:3000

#get grafana password:

kubectl get secret prometheus-grafana -o jsonpath="{.data.admin-password}" | base64 --decode ; echo
username will be admin

#Access Prometheus locally

k port-forward service/prometheus-kube-prometheus-prometheus 9090 -n monitoring
localhost:9090

#Set up Nginx Ingress Controller in ingress-nginx namespace

helm upgrade --install ingress-nginx ingress-nginx \
 --repo https://kubernetes.github.io/ingress-nginx \
 --namespace ingress-nginx --create-namespace

#Verify 
kubectl get pod,svc -n ingress-nginx
#get the IP of the Load Balanser assigned to the service 

#Expose Grafana and Prometheus using Ingress
#Create ingress resource file and apply
kubectl apply -f ingress-grafana-prom.yaml
k describe ingress -n monitoring
Name:             grafana-prom-ingress
Labels:           <none>
Namespace:        monitoring
Address:
Ingress Class:    nginx
Default backend:  <default>
Rules:
  Host                   Path  Backends
  ----                   ----  --------
  grafana.honeybunny.no
                         /   prometheus-grafana:3000 ()
  prom.honeybunny.no
                         /   prometheus-kube-prometheus-prometheus:9090 (192.168.59.206:9090)

#Since the domain is not registered, update hosts file with the IP of load balancer to access the subdomains
#Access Grafana and Prometheus in browser 

